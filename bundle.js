(()=>{"use strict";!function(){const e=[{palace:{name:"Дворец",price:1e4}},{flat:{name:"Квартира",price:1e3}},{house:{name:"Дом",price:5e3}},{bungalow:{name:"Бунгало",price:0}}];window.data={getTypeValue:(t,n)=>e.filter((e=>e.hasOwnProperty(t)))[0][t][n],getData:e=>{window.network.loadData(e,(e=>{window.render.renderLoadErrorMessage(e)}))},adsData:void 0}}(),window.util={isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))},isLeftMouseButtonEvent:(e,t)=>{0===e.button&&(e.preventDefault(),t(e))},isEscapeEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}},function(){const e=e=>{const t=e.querySelector(".map__card");t&&e.removeChild(t)},t=(t,n)=>{e(n),window.render.renderCard((e=>{const t=e.alt?e.alt:e.querySelector("img").alt;return window.data.adsData.filter((e=>e.offer.title===t))})(t.target)[0],n)};window.card={create:(e,t)=>{const n=t.cloneNode(!0);return n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.getTypeValue(e.offer.type,"name"),n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").innerHTML=`${e.offer.checkin}, выезд&nbsp;до ${e.offer.checkout}`,((e,t)=>{const n=t.querySelector(".popup__features"),o=n.cloneNode();e.forEach((e=>{o.appendChild(n.querySelector(".popup__feature--"+e))}));for(let e=n.children.length-1;e>=0;e--)n.children[e].classList.add("hidden");for(let e=o.children.length-1;e>=0;e--)n.appendChild(o.children[e])})(e.offer.features,n),n.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const n=t.querySelector(".popup__photos"),o=n.querySelector(".popup__photo");e.forEach((e=>{const t=o.cloneNode();t.src=e,n.appendChild(t)})),n.removeChild(o)})(e.offer.photos,n),n.querySelector(".popup__avatar").src=e.author.avatar,n},close:e,onCardOpen:(e,n)=>{e.target.closest(".map__pin")&&!e.target.closest(".map__pin--main")&&("keydown"===e.type?window.util.isEnterEvent(e,(()=>{t(e,n)})):"mousedown"===e.type&&window.util.isLeftMouseButtonEvent(e,(()=>{t(e,n)})))},onCardClose:(t,n)=>{"keydown"===t.type?window.util.isEscapeEvent(t,(()=>{e(n)})):"mousedown"===t.type&&"popup__close"===t.target.className&&window.util.isLeftMouseButtonEvent(t,(()=>{e(n)}))}}}(),function(){const e=document.querySelector(".map");window.map={click:()=>{e.addEventListener("mousedown",(t=>{window.card.onCardOpen(t,e),window.card.onCardClose(t,e)})),e.addEventListener("keydown",(t=>{window.card.onCardOpen(t,e)})),document.addEventListener("keydown",(t=>{window.card.onCardClose(t,e)}))},get:()=>e,toggle:()=>{e.classList.toggle("map--faded")},checkMapActivity:()=>!e.classList.contains("map--faded")}}(),function(){let e=!1;const t=t=>{e=!0,window.map.toggle(),window.form.switchForm(),window.form.toggleForms(),window.form.setAddress(),window.validation.start(),window.render.renderData(),window.filter.change(),window.form.clear(),window.form.setAvatar(),window.form.setPhoto(),window.form.submissionHandler(),t.removeEventListener("mousedown",n),t.removeEventListener("keydown",n)},n=(e,n)=>{"keydown"===e.type?window.util.isEnterEvent(e,(()=>{t(n)})):"mousedown"===e.type&&window.util.isLeftMouseButtonEvent(e,(()=>{t(n)}))};window.state={deactivate:()=>{e=!1,window.map.toggle(),window.form.switchForm(),window.form.toggleForms(),window.validation.setNumPlaces(),window.validation.stop(),window.render.removePins(),window.card.close(window.map.get()),window.pin.resetPosition(),window.form.setAddress(),window.form.setPriceRange(),window.filter.stopChange(),window.form.stopSubmissionHandler()},onActivation:n,isActiveState:()=>e}}(),function(){const e=document.querySelector(".map__pin--main"),t=window.map.get().clientWidth;let n,o;const r=r=>{let i={x:r.clientX,y:r.clientY};const d=r=>{r.preventDefault(),(r=>{const d=i.x-r.clientX,a=i.y-r.clientY;i={x:r.clientX,y:r.clientY},window.form.setAddress(),e.style.left=n-d>=0&&n-d<=t?String(e.offsetLeft-d)+"px":String(e.offsetLeft)+"px",e.style.top=o-a>=130&&o-a<=630?String(e.offsetTop-a)+"px":String(e.offsetTop)+"px"})(r),window.form.setAddress()},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",a)};window.pin={initApp:()=>{e.addEventListener("mousedown",(t=>{window.state.isActiveState()||window.state.onActivation(t,e),r(t)})),e.addEventListener("keydown",(t=>{window.state.isActiveState()||window.state.onActivation(t,e)}))},create:(e,t)=>{const n=t.cloneNode(!0),o=n.querySelector("img");return n.style.left=String(e.location.x-25)+"px",n.style.top=String(e.location.y-70)+"px",o.src=e.author.avatar,o.alt=e.offer.title,n},getCoordinate:()=>((()=>{const t=e.offsetLeft,r=e.offsetTop,i=e.offsetWidth,d=e.clientHeight,a=parseInt(getComputedStyle(e,":after").height,10);n=Math.floor(t+i/2),o=window.map.checkMapActivity()?Math.floor(r+d+a):Math.floor(r+d/2)})(),`${n}, ${o}`),onMoveMainMapPin:r,resetPosition:()=>{e.style.left=String(Math.floor(t/2)-30)+"px",e.style.top=String(375)+"px"}}}(),function(){let e,t,n,o;const r=(e="1")=>{const t=document.querySelector("#capacity"),n=t.cloneNode(!0);for(let t=n.children.length-1;t>=0;t--)n.children[t].disabled="100"===e?"0"!==n.children[t].value:n.children[t].value>e||"0"===n.children[t].value;t.innerHTML=null,t.insertAdjacentHTML("beforeend",n.innerHTML),t.value="100"!==e?e:"0"},i=e=>{(e=>{const t=String(window.data.getTypeValue(e,"price"));window.form.setPriceRange(t)})(e.target.value)},d=e=>{var o;o=e.target.value,"timein"===e.target.id?n.value=o:t.value=o},a=e=>{r(e.target.value)};window.validation={start:()=>{e=document.querySelector("#type"),t=document.querySelector("#timein"),n=document.querySelector("#timeout"),o=document.querySelector("#room_number"),e.addEventListener("input",i),t.addEventListener("input",d),n.addEventListener("input",d),o.addEventListener("input",a)},stop:()=>{e.removeEventListener("input",i),t.removeEventListener("input",d),n.removeEventListener("input",d),o.removeEventListener("input",a)},setNumPlaces:r}}(),function(){const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n=document.querySelector("main"),o=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let n=0;n<e.length;n++)t.removeChild(e[n])},r=n=>{const r=document.createDocumentFragment();n.forEach((t=>{if(t.offer){const n=window.pin.create(t,e);r.appendChild(n)}})),o(),t.appendChild(r)};window.render={renderData:()=>{window.data.getData((e=>{window.data.adsData=e,r(window.filter.limitQuantity())}))},renderCard:(e,t)=>{const n=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),r=document.createDocumentFragment(),i=window.card.create(e,n);r.appendChild(i),t.insertBefore(r,o)},renderMapPins:r,removePins:o,renderSuccessMessage:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),n.appendChild(t)},renderErrorMessage:()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),n.appendChild(t)},removeMessage:e=>{n.removeChild(e)},renderLoadErrorMessage:e=>{const t=document.createElement("p");t.innerHTML=e,n.appendChild(t)}}}(),function(){const e="any",t=document.querySelector(".map__filters");let n;const o=(e=window.data.adsData)=>e.slice(0,5),r=()=>{n&&window.clearTimeout(n),n=window.setTimeout((function(){(()=>{const n=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),i=t.querySelector("#housing-rooms"),d=t.querySelector("#housing-guests"),a=t.querySelector("#filter-wifi"),s=t.querySelector("#filter-dishwasher"),c=t.querySelector("#filter-parking"),u=t.querySelector("#filter-washer"),l=t.querySelector("#filter-elevator"),w=t.querySelector("#filter-conditioner"),p=window.data.adsData.filter((t=>{return(n.value===e||n.value===t.offer.type)&&(r.value===e||(o=t.offer.price,!("middle"===r.value&&(o<1e4||o>5e4)||"low"===r.value&&o>=1e4||"high"===r.value&&o<=5e4)))&&(i.value===e||parseInt(i.value,10)===t.offer.rooms)&&(d.value===e||parseInt(d.value,10)===t.offer.guests)&&(a.checked&&t.offer.features.includes(a.value)||!a.checked)&&(s.checked&&t.offer.features.includes(s.value)||!s.checked)&&(c.checked&&t.offer.features.includes(c.value)||!c.checked)&&(u.checked&&t.offer.features.includes(u.value)||!u.checked)&&(l.checked&&t.offer.features.includes(l.value)||!l.checked)&&(w.checked&&t.offer.features.includes(w.value)||!w.checked);var o}));window.card.close(window.map.get()),window.render.renderMapPins(o(p))})()}),500)};window.filter={getFilterElement:()=>t,limitQuantity:o,change:()=>{t.addEventListener("change",r)},stopChange:()=>{t.removeEventListener("change",r)}}}(),function(){const e="json",t=e=>{e.removeEventListener("load",n),e.removeEventListener("error",r),e.removeEventListener("timeout",o)},n=(e,n,o)=>{200===e.status?n(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`),t(e)},o=(e,n)=>{n(`Запрос не успел выполниться за ${e.timeout} мс`),t(e)},r=(e,n)=>{n("Произошла ошибка соединения"),t(e)};window.network={uploadFormData:(n,i,d)=>{const a=new XMLHttpRequest;a.timeout=1e4,a.responseType=e,a.addEventListener("load",(()=>{((e,n)=>{n(e.response),t(e)})(a,i)})),a.addEventListener("error",(()=>{r(a,d)})),a.addEventListener("timeout",(()=>{o(a,d)})),a.open("POST","https://21.javascript.pages.academy/keksobooking"),a.send(n)},loadData:(t,i)=>{const d=new XMLHttpRequest;d.timeout=1e4,d.responseType=e,d.addEventListener("load",(()=>{n(d,t,i)})),d.addEventListener("error",(()=>{r(d,i)})),d.addEventListener("timeout",(()=>{o(d,i)})),d.open("GET","https://21.javascript.pages.academy/keksobooking/data"),d.send()}}}(),function(){const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),n=document.querySelector(".error__button");let o;const r=()=>{const e=document.querySelector(".error");window.render.removeMessage(e),document.removeEventListener("mousedown",i),n.addEventListener("mousedown",i),document.removeEventListener("keydown",i)},i=e=>{"keydown"===e.type?e.target.classList.contains("error__button")?window.util.isEnterEvent(e,r):window.util.isEscapeEvent(e,r):"mousedown"===e.type&&window.util.isLeftMouseButtonEvent(e,r)},d=()=>{window.render.renderErrorMessage(),document.addEventListener("mousedown",i),n.addEventListener("mousedown",i),document.addEventListener("keydown",i)},a=()=>{const e=document.querySelector(".success");window.render.removeMessage(e),document.removeEventListener("mousedown",s),document.removeEventListener("keydown",s)},s=e=>{"keydown"===e.type?window.util.isEscapeEvent(e,a):"mousedown"===e.type&&window.util.isLeftMouseButtonEvent(e,a)},c=()=>{window.state.deactivate(),window.render.renderSuccessMessage(),document.addEventListener("mousedown",s),document.addEventListener("keydown",s)},u=e=>{e.preventDefault(),window.network.uploadFormData(new FormData(t),c,d)},l=()=>{window.state.deactivate(),o.removeEventListener("mousedown",w),o.removeEventListener("keydown",w)},w=e=>{"keydown"===e.type?window.util.isEnterEvent(e,l):"mousedown"===e.type&&window.util.isLeftMouseButtonEvent(e,l)},p=(t,n)=>{const o=t.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if("IMG"===n.tagName)n.src=e.result;else{const t=document.createElement("img");t.src=e.result,t.alt=r,t.width=70,t.height=70,n.appendChild(t)}})),e.readAsDataURL(o)}};window.form={switchForm:()=>{t.classList.toggle("ad-form--disabled")},toggleForm:e=>{const t=e.cloneNode(!0);for(let e of t.children)e.disabled=!e.disabled;e.innerHTML=null,e.insertAdjacentHTML("beforeend",t.innerHTML)},setAddress:()=>{document.querySelector("#address").value=window.pin.getCoordinate()},toggleForms:()=>{window.form.toggleForm(t),window.form.toggleForm(window.filter.getFilterElement())},submissionHandler:()=>{t.addEventListener("submit",u)},stopSubmissionHandler:()=>{t.addEventListener("submit",u)},clear:()=>{o=t.querySelector(".ad-form__reset"),o.addEventListener("mousedown",w),o.addEventListener("keydown",w)},setPriceRange:(e=1e3)=>{const t=document.querySelector("#price");t.placeholder=e,t.min=e},setAvatar:()=>{const e=t.querySelector(".ad-form-header__input"),n=t.querySelector(".ad-form-header__preview img");e.addEventListener("change",(()=>{p(e,n)}))},setPhoto:()=>{const e=t.querySelector(".ad-form__input"),n=t.querySelector(".ad-form__photo");e.addEventListener("change",(()=>{p(e,n)}))}}}(),window.form.toggleForms(),window.pin.initApp(),window.form.setAddress(),window.map.click()})();