(()=>{"use strict";!function(){const e=[{palace:{name:"Дворец",price:1e4}},{flat:{name:"Квартира",price:1e3}},{house:{name:"Дом",price:5e3}},{bungalow:{name:"Бунгало",price:0}}];window.data={getTypeValue:(t,n)=>e.filter((e=>e.hasOwnProperty(t)))[0][t][n],getData:e=>{window.network.loadData(e,(e=>{(e=>{window.render.renderCustomErrorMessage(e),document.addEventListener("mousedown",window.form.onCloseErrorMsg),document.addEventListener("keydown",window.form.onCloseErrorMsg)})(e)}))},adsData:void 0}}(),window.util={enterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))},leftMouseButtonEvent:(e,t)=>{0===e.button&&(e.preventDefault(),t(e))},escapeEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}},function(){const e=e=>{const t=e.querySelector(".map__card");t&&e.removeChild(t)},t=(t,n)=>{e(n),window.render.renderCard((e=>{const t=e.alt?e.alt:e.querySelector("img").alt;return window.data.adsData.filter((e=>e.offer.title===t))})(t.target)[0],n)};window.card={create:(e,t)=>{const n=t.cloneNode(!0);return n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.getTypeValue(e.offer.type,"name"),n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").innerHTML=`${e.offer.checkin}, выезд&nbsp;до ${e.offer.checkout}`,((e,t)=>{const n=t.querySelector(".popup__features"),o=n.cloneNode();e.forEach((e=>{o.appendChild(n.querySelector(".popup__feature--"+e))}));for(let e=n.children.length-1;e>=0;e--)n.children[e].classList.add("hidden");for(let e=o.children.length-1;e>=0;e--)n.appendChild(o.children[e])})(e.offer.features,n),n.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const n=t.querySelector(".popup__photos"),o=n.querySelector(".popup__photo");e.forEach((e=>{const t=o.cloneNode();t.src=e,n.appendChild(t)})),n.removeChild(o)})(e.offer.photos,n),n.querySelector(".popup__avatar").src=e.author.avatar,n},close:e,onCardOpen:(e,n)=>{e.target.closest(".map__pin")&&!e.target.closest(".map__pin--main")&&("keydown"===e.type?window.util.enterEvent(e,(()=>{t(e,n)})):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,(()=>{t(e,n)})))},onCardClose:(t,n)=>{"keydown"===t.type?window.util.escapeEvent(t,(()=>{e(n)})):"mousedown"===t.type&&"popup__close"===t.target.className&&window.util.leftMouseButtonEvent(t,(()=>{e(n)}))}}}(),function(){const e=document.querySelector(".map");window.map={click:()=>{e.addEventListener("mousedown",(t=>{window.card.onCardOpen(t,e),window.card.onCardClose(t,e)})),e.addEventListener("keydown",(t=>{window.card.onCardOpen(t,e)})),document.addEventListener("keydown",(t=>{window.card.onCardClose(t,e)}))},get:()=>e,toggle:()=>{e.classList.toggle("map--faded")},checkMapActivity:()=>!e.classList.contains("map--faded")}}(),function(){let e=!1;const t=t=>{e=!0,window.map.toggle(),window.form.switchState(),window.form.toggle(),window.form.toggle(window.filter.getFilterElement()),window.form.setAddress(),window.validation.start(),window.render.renderData(),window.filter.change(),window.form.clear(),window.form.setAvatar(),window.form.setPhoto(),window.form.submissionHandler(),t.removeEventListener("mousedown",n),t.removeEventListener("keydown",n)},n=(e,n)=>{"keydown"===e.type?window.util.enterEvent(e,(()=>{t(n)})):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,(()=>{t(n)}))};window.state={deactivate:()=>{e=!1,window.map.toggle(),window.form.switchState(),window.form.toggle(),window.form.toggle(window.filter.getFilterElement()),window.validation.setNumPlaces(),window.validation.stop(),window.render.removePins(),window.card.close(window.map.get()),window.pin.resetPosition(),window.form.setAddress(),window.form.setPriceRange(),window.filter.stopChange(),window.form.stopSubmissionHandler(),window.form.resetPhotos()},onActivation:n,isActiveState:()=>e}}(),function(){const e=document.querySelector(".map__pin--main"),t=window.map.get().clientWidth;let n,o;const r=r=>{let d={x:r.clientX,y:r.clientY};const i=r=>{r.preventDefault(),(r=>{const i=d.x-r.clientX,s=d.y-r.clientY;d={x:r.clientX,y:r.clientY},window.form.setAddress(),e.style.left=n-i>=0&&n-i<=t?String(e.offsetLeft-i)+"px":String(e.offsetLeft)+"px",e.style.top=o-s>=130&&o-s<=630?String(e.offsetTop-s)+"px":String(e.offsetTop)+"px"})(r),window.form.setAddress()},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)};window.pin={initApp:()=>{e.addEventListener("mousedown",(t=>{window.state.isActiveState()||window.state.onActivation(t,e),r(t)})),e.addEventListener("keydown",(t=>{window.state.isActiveState()||window.state.onActivation(t,e)}))},create:(e,t)=>{const n=t.cloneNode(!0),o=n.querySelector("img");return n.style.left=String(e.location.x-25)+"px",n.style.top=String(e.location.y-70)+"px",o.src=e.author.avatar,o.alt=e.offer.title,n},getCoordinate:()=>((()=>{const t=e.offsetLeft,r=e.offsetTop,d=e.offsetWidth,i=e.clientHeight,s=parseInt(getComputedStyle(e,":after").height,10);n=Math.floor(t+d/2),o=window.map.checkMapActivity()?Math.floor(r+i+s):Math.floor(r+i/2)})(),`${n}, ${o}`),onMoveMainMapPin:r,resetPosition:()=>{e.style.left=String(Math.floor(t/2)-30)+"px",e.style.top=String(375)+"px"}}}(),function(){let e,t,n,o;const r=(e="1")=>{const t=document.querySelector("#capacity"),n=t.cloneNode(!0);for(let t=n.children.length-1;t>=0;t--)n.children[t].disabled="100"===e?"0"!==n.children[t].value:n.children[t].value>e||"0"===n.children[t].value;t.innerHTML=null,t.insertAdjacentHTML("beforeend",n.innerHTML),t.value="100"!==e?e:"0"},d=e=>{(e=>{const t=String(window.data.getTypeValue(e,"price"));window.form.setPriceRange(t)})(e.target.value)},i=e=>{var o;o=e.target.value,"timein"===e.target.id?n.value=o:t.value=o},s=e=>{r(e.target.value)};window.validation={start:()=>{e=document.querySelector("#type"),t=document.querySelector("#timein"),n=document.querySelector("#timeout"),o=document.querySelector("#room_number"),e.addEventListener("input",d),t.addEventListener("input",i),n.addEventListener("input",i),o.addEventListener("input",s)},stop:()=>{e.removeEventListener("input",d),t.removeEventListener("input",i),n.removeEventListener("input",i),o.removeEventListener("input",s)},setNumPlaces:r}}(),function(){const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n=document.querySelector("main"),o=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let n=0;n<e.length;n++)t.removeChild(e[n])},r=n=>{const r=document.createDocumentFragment();n.forEach((t=>{if(t.offer){const n=window.pin.create(t,e);r.appendChild(n)}})),o(),t.appendChild(r)};window.render={renderData:()=>{window.data.getData((e=>{window.data.adsData=e,r(window.filter.limitQuantity())}))},renderCard:(e,t)=>{const n=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),r=document.createDocumentFragment(),d=window.card.create(e,n);r.appendChild(d),t.insertBefore(r,o)},renderMapPins:r,removePins:o,renderSuccessMessage:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),n.appendChild(t)},renderErrorMessage:()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),n.appendChild(t)},removeMessage:e=>{n.removeChild(e)},renderCustomErrorMessage:e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(),o=document.createElement("p");o.innerHTML=e,o.classList.add("error__message"),t.appendChild(o),n.appendChild(t)}}}(),function(){const e="any",t=document.querySelector(".map__filters");let n;const o=(e=window.data.adsData)=>e.slice(0,5),r=()=>{n&&window.clearTimeout(n),n=window.setTimeout((function(){(()=>{const n=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),d=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),s=t.querySelector("#filter-wifi"),a=t.querySelector("#filter-dishwasher"),c=t.querySelector("#filter-parking"),l=t.querySelector("#filter-washer"),u=t.querySelector("#filter-elevator"),w=t.querySelector("#filter-conditioner"),m=window.data.adsData.filter((t=>{return(n.value===e||n.value===t.offer.type)&&(r.value===e||(o=t.offer.price,!("middle"===r.value&&(o<1e4||o>5e4)||"low"===r.value&&o>=1e4||"high"===r.value&&o<=5e4)))&&(d.value===e||parseInt(d.value,10)===t.offer.rooms)&&(i.value===e||parseInt(i.value,10)===t.offer.guests)&&(s.checked&&t.offer.features.includes(s.value)||!s.checked)&&(a.checked&&t.offer.features.includes(a.value)||!a.checked)&&(c.checked&&t.offer.features.includes(c.value)||!c.checked)&&(l.checked&&t.offer.features.includes(l.value)||!l.checked)&&(u.checked&&t.offer.features.includes(u.value)||!u.checked)&&(w.checked&&t.offer.features.includes(w.value)||!w.checked);var o}));window.card.close(window.map.get()),window.render.renderMapPins(o(m))})()}),500)};window.filter={getFilterElement:()=>t,limitQuantity:o,change:()=>{t.addEventListener("change",r)},stopChange:()=>{t.removeEventListener("change",r)}}}(),function(){const e="json",t=e=>{e.removeEventListener("load",n),e.removeEventListener("error",r),e.removeEventListener("timeout",o)},n=(e,n,o)=>{200===e.status?n(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`),t(e)},o=(e,n)=>{n(`Запрос не успел выполниться за ${e.timeout} мс`),t(e)},r=(e,n)=>{n("Произошла ошибка соединения"),t(e)};window.network={uploadFormData:(n,d,i)=>{const s=new XMLHttpRequest;s.timeout=1e4,s.responseType=e,s.addEventListener("load",(()=>{((e,n)=>{n(e.response),t(e)})(s,d)})),s.addEventListener("error",(()=>{r(s,i)})),s.addEventListener("timeout",(()=>{o(s,i)})),s.open("POST","https://21.javascript.pages.academy/keksobooking"),s.send(n)},loadData:(t,d)=>{const i=new XMLHttpRequest;i.timeout=1e4,i.responseType=e,i.addEventListener("load",(()=>{n(i,t,d)})),i.addEventListener("error",(()=>{r(i,d)})),i.addEventListener("timeout",(()=>{o(i,d)})),i.open("GET","https://21.javascript.pages.academy/keksobooking/data"),i.send()}}}(),function(){const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form");let n,o;const r=()=>{const e=document.querySelector(".error");window.render.removeMessage(e),document.removeEventListener("mousedown",d),o.removeEventListener("keydown",d),document.removeEventListener("keydown",d)},d=e=>{"keydown"===e.type?e.target.classList.contains("error__button")?window.util.enterEvent(e,r):window.util.escapeEvent(e,r):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,r)},i=()=>{window.render.renderErrorMessage(),o=document.querySelector(".error__button"),document.addEventListener("mousedown",d),o.addEventListener("keydown",d),document.addEventListener("keydown",d)},s=()=>{const e=document.querySelector(".success");window.render.removeMessage(e),document.removeEventListener("mousedown",a),document.removeEventListener("keydown",a)},a=e=>{"keydown"===e.type?window.util.escapeEvent(e,s):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,s)},c=()=>{window.state.deactivate(),window.render.renderSuccessMessage(),document.addEventListener("mousedown",a),document.addEventListener("keydown",a)},l=e=>{e.preventDefault(),window.network.uploadFormData(new FormData(t),c,i)},u=()=>{window.state.deactivate(),n.removeEventListener("mousedown",w),n.removeEventListener("keydown",w)},w=e=>{"keydown"===e.type?window.util.enterEvent(e,u):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,u)},m=(e,t)=>{((e,t)=>{if("IMG"===t.tagName)t.src=e.result;else{const n=document.createElement("img");n.src=e.result,n.width=70,n.height=70,t.appendChild(n)}e.removeEventListener("load",(()=>{m(e,t)}))})(e,t)},p=()=>{const e=document.querySelector(".error");window.render.removeMessage(e),document.removeEventListener("mousedown",f),document.removeEventListener("keydown",f)},f=e=>{"keydown"===e.type?window.util.escapeEvent(e,p):"mousedown"===e.type&&window.util.leftMouseButtonEvent(e,p)},v=(t,n)=>{const o=t.files[0],r=o.name.toLowerCase(),d=e.some((e=>r.endsWith(e)));try{if(!d)throw new Error("Загружать можно только картинки, следующих форматов: gif, jpg, jpeg, png");{const e=new FileReader;e.addEventListener("load",(()=>{m(e,n)})),e.readAsDataURL(o)}}catch(e){window.render.renderCustomErrorMessage(e.message),document.addEventListener("mousedown",f),document.addEventListener("keydown",f)}};window.form={switchState:()=>{t.classList.toggle("ad-form--disabled")},toggle:(e=t)=>{const n=e.cloneNode(!0);for(let e of n.children)e.disabled=!e.disabled;e.innerHTML=null,e.insertAdjacentHTML("beforeend",n.innerHTML)},setAddress:()=>{document.querySelector("#address").value=window.pin.getCoordinate()},submissionHandler:()=>{t.addEventListener("submit",l)},stopSubmissionHandler:()=>{t.addEventListener("submit",l)},clear:()=>{n=t.querySelector(".ad-form__reset"),n.addEventListener("mousedown",w),n.addEventListener("keydown",w)},setPriceRange:(e=1e3)=>{const t=document.querySelector("#price");t.placeholder=e,t.min=e},setAvatar:()=>{const e=t.querySelector(".ad-form-header__input"),n=t.querySelector(".ad-form-header__preview img");e.addEventListener("change",(()=>{v(e,n)}))},setPhoto:()=>{const e=t.querySelector(".ad-form__input"),n=t.querySelector(".ad-form__photo");e.addEventListener("change",(()=>{v(e,n)}))},resetPhotos:()=>{const e=t.querySelector(".ad-form-header__preview img"),n=t.querySelector(".ad-form__photo");e.src="img/muffin-grey.svg",n.innerHTML=""},onCloseErrorMsg:f}}(),window.form.toggle(),window.form.toggle(window.filter.getFilterElement()),window.pin.initApp(),window.form.setAddress(),window.map.click()})();