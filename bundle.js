(()=>{"use strict";!function(){const e=[{palace:{name:"Дворец",price:1e4}},{flat:{name:"Квартира",price:1e3}},{house:{name:"Дом",price:5e3}},{bungalow:{name:"Бунгало",price:0}}],t=document.querySelector(".map__error-message");let o;window.data={getTypeValue:(t,o)=>e.filter((e=>e.hasOwnProperty(t)))[0][t][o],load:()=>{window.state.isActive()||window.network.loadData((e=>{o=e,window.state.activate()}),(e=>{(e=>{t.querySelector(".error-message__text").textContent=e+" Пожалуйста перезагрузите страницу",t.classList.add("error-message--show")})(e)}))},get:()=>o}}(),window.util={pressEnter:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))},pressLeftMouseButton:(e,t)=>{0===e.button&&(e.preventDefault(),t(e))},pressEscape:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())}},function(){const e=document.querySelector(".map");window.map={get:()=>e,toggle:()=>{e.classList.toggle("map--faded")},checkActivity:()=>!e.classList.contains("map--faded")}}(),function(){const e=window.map.get();let t;const o=()=>{const o=e.querySelector(".map__card");o&&(t.removeEventListener("mousedown",i),t.removeEventListener("keydown",i),document.removeEventListener("keydown",i),e.removeChild(o),window.pin.deactivate())},n=n=>{o(),window.pin.activate(n.target),window.view.renderCard((e=>{const t=e.alt?e.alt:e.querySelector("img").alt;return window.data.get().filter((e=>e.offer.title===t))})(n.target)[0],e),t=document.querySelector(".popup__close"),t.addEventListener("mousedown",i),t.addEventListener("keydown",i),document.addEventListener("keydown",i)},r=e=>{e.target.closest(".map__pin")&&!e.target.closest(".map__pin--main")&&("keydown"===e.type?window.util.pressEnter(e,(()=>{n(e)})):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,(()=>{n(e)})))},i=e=>{"keydown"===e.type?"popup__close"===e.target.className?window.util.pressEnter(e,o):window.util.pressEscape(e,o):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,o)};window.card={clickOnMapHandler:()=>{e.addEventListener("mousedown",r),e.addEventListener("keydown",r)},stopClickOnMapHandler:()=>{e.removeEventListener("mousedown",r),e.removeEventListener("keydown",r)},create:(e,t)=>{const o=t.cloneNode(!0);return o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=window.data.getTypeValue(e.offer.type,"name"),o.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,o.querySelector(".popup__text--time").innerHTML=`${e.offer.checkin}, выезд&nbsp;до ${e.offer.checkout}`,((e,t)=>{const o=t.querySelector(".popup__features"),n=o.cloneNode();e.forEach((e=>{n.appendChild(o.querySelector(".popup__feature--"+e))}));for(let e=o.children.length-1;e>=0;e--)o.children[e].classList.add("hidden");for(let e=n.children.length-1;e>=0;e--)o.appendChild(n.children[e])})(e.offer.features,o),o.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const o=t.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");e.forEach((e=>{const t=n.cloneNode();t.src=e,o.appendChild(t)})),o.removeChild(n)})(e.offer.photos,o),o.querySelector(".popup__avatar").src=e.author.avatar,o},close:o}}(),function(){let e=!1;window.state={activate:()=>{e=!0,window.map.toggle(),window.form.switchState(),window.form.toggle(),window.form.toggle(window.filter.getElement()),window.form.setAddress(),window.validation.setNumPlaces(),window.validation.start(),window.view.renderPins(window.filter.limitQuantity()),window.filter.change(),window.form.clear(),window.form.setAvatar(),window.form.setPhoto(),window.form.startHandling(),window.card.clickOnMapHandler()},deactivate:()=>{e=!1,window.map.toggle(),window.form.switchState(),window.form.reset(),window.form.reset(window.filter.getElement()),window.form.toggle(),window.form.toggle(window.filter.getElement()),window.validation.stop(),window.view.removePins(),window.card.close(),window.pin.resetPosition(),window.form.setAddress(),window.form.setPriceRange(),window.filter.stopChange(),window.form.stopHandling(),window.form.resetPhotos(),window.card.stopClickOnMapHandler()},onAppActivation:e=>{"keydown"===e.type?window.util.pressEnter(e,window.data.load):"mousedown"===e.type&&(window.util.pressLeftMouseButton(e,window.pin.mouseMoveHandler),window.util.pressLeftMouseButton(e,window.data.load))},isActive:()=>e}}(),function(){const e=document.querySelector(".map__pin--main"),t=window.map.get().clientWidth;let o,n;const r=r=>{r.preventDefault(),(r=>{const i=n.x-r.clientX,s=n.y-r.clientY;n={x:r.clientX,y:r.clientY},window.form.setAddress(),e.style.left=o.x-i>=0&&o.x-i<=t?String(e.offsetLeft-i)+"px":String(e.offsetLeft)+"px",e.style.top=o.y-s>=130&&o.y-s<=630?String(e.offsetTop-s)+"px":String(e.offsetTop)+"px"})(r)},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i)};window.pin={mouseMoveHandler:e=>{n={x:e.clientX,y:e.clientY},document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)},initApp:()=>{e.addEventListener("mousedown",window.state.onAppActivation),e.addEventListener("keydown",window.state.onAppActivation)},create:(e,t)=>{const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.left=String(e.location.x-25)+"px",o.style.top=String(e.location.y-70)+"px",n.src=e.author.avatar,n.alt=e.offer.title,o},getCoordinate:()=>((()=>{const t=e.offsetLeft,n=e.offsetTop,r=e.offsetWidth,i=e.clientHeight,s=parseInt(getComputedStyle(e,":after").height,10);o={x:Math.floor(t+r/2),y:window.map.checkActivity()?Math.floor(n+i+s):Math.floor(n+i/2)}})(),`${o.x}, ${o.y}`),resetPosition:()=>{e.style.left=String(Math.floor(t/2)-30)+"px",e.style.top=String(375)+"px"},activate:e=>{e.classList.contains("map__pin")?e.classList.add("map__pin--active"):e.parentElement.classList.add("map__pin--active")},deactivate:()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}}(),function(){let e,t,o,n;const r=(e="1")=>{const t=document.querySelector("#capacity");for(let o=t.children.length-1;o>=0;o--)t.children[o].disabled="100"===e?"0"!==t.children[o].value:t.children[o].value>e||"0"===t.children[o].value;t.value="100"!==e?e:"0"},i=e=>{(e=>{const t=String(window.data.getTypeValue(e,"price"));window.form.setPriceRange(t)})(e.target.value)},s=e=>{var n;n=e.target.value,"timein"===e.target.id?o.value=n:t.value=n},d=e=>{r(e.target.value)};window.validation={start:()=>{e=document.querySelector("#type"),t=document.querySelector("#timein"),o=document.querySelector("#timeout"),n=document.querySelector("#room_number"),e.addEventListener("input",i),t.addEventListener("input",s),o.addEventListener("input",s),n.addEventListener("input",d)},stop:()=>{e.removeEventListener("input",i),t.removeEventListener("input",s),o.removeEventListener("input",s),n.removeEventListener("input",d)},setNumPlaces:r}}(),function(){const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=document.querySelector("main"),n=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let o=0;o<e.length;o++)t.removeChild(e[o])};window.view={renderCard:(e,t)=>{const o=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector(".map__filters-container"),r=document.createDocumentFragment(),i=window.card.create(e,o);r.appendChild(i),t.insertBefore(r,n)},renderPins:o=>{const r=document.createDocumentFragment();o.forEach((t=>{if(t.offer){const o=window.pin.create(t,e);r.appendChild(o)}})),n(),t.appendChild(r)},removePins:n,renderSuccessMessage:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),o.appendChild(t)},renderErrorMessage:()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=document.createDocumentFragment();t.appendChild(e),o.appendChild(t)},removeMessage:e=>{o.removeChild(e)}}}(),function(){const e="any",t=document.querySelector(".map__filters");let o;const n=(e=window.data.get())=>e.slice(0,5),r=()=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{(()=>{const o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),i=t.querySelector("#housing-rooms"),s=t.querySelector("#housing-guests"),d=t.querySelector("#filter-wifi"),a=t.querySelector("#filter-dishwasher"),c=t.querySelector("#filter-parking"),l=t.querySelector("#filter-washer"),u=t.querySelector("#filter-elevator"),w=t.querySelector("#filter-conditioner"),p=window.data.get().filter((t=>{return(o.value===e||o.value===t.offer.type)&&(r.value===e||(n=t.offer.price,!("middle"===r.value&&(n<1e4||n>5e4)||"low"===r.value&&n>=1e4||"high"===r.value&&n<=5e4)))&&(i.value===e||parseInt(i.value,10)===t.offer.rooms)&&(s.value===e||parseInt(s.value,10)===t.offer.guests)&&(d.checked&&t.offer.features.includes(d.value)||!d.checked)&&(a.checked&&t.offer.features.includes(a.value)||!a.checked)&&(c.checked&&t.offer.features.includes(c.value)||!c.checked)&&(l.checked&&t.offer.features.includes(l.value)||!l.checked)&&(u.checked&&t.offer.features.includes(u.value)||!u.checked)&&(w.checked&&t.offer.features.includes(w.value)||!w.checked);var n}));window.card.close(),window.view.renderPins(n(p))})()}),500)};window.filter={getElement:()=>t,limitQuantity:n,change:()=>{t.addEventListener("change",r)},stopChange:()=>{t.removeEventListener("change",r)}}}(),function(){const e="json",t=e=>{e.removeEventListener("load",o),e.removeEventListener("error",r),e.removeEventListener("timeout",n)},o=(e,o,n)=>{200===e.status?o(e.response):n(`Статус ответа: ${e.status} ${e.statusText}.`),t(e)},n=(e,o)=>{o(`Запрос не успел выполниться за ${e.timeout} мс.`),t(e)},r=(e,o)=>{o("Произошла ошибка соединения."),t(e)};window.network={uploadFormData:(t,i,s)=>{const d=new XMLHttpRequest;d.timeout=1e4,d.responseType=e,d.addEventListener("load",(()=>{o(d,i,s)})),d.addEventListener("error",(()=>{r(d,s)})),d.addEventListener("timeout",(()=>{n(d,s)})),d.open("POST","https://21.javascript.pages.academy/keksobooking"),d.send(t)},loadData:(t,i)=>{const s=new XMLHttpRequest;s.timeout=1e4,s.responseType=e,s.addEventListener("load",(()=>{o(s,t,i)})),s.addEventListener("error",(()=>{r(s,i)})),s.addEventListener("timeout",(()=>{n(s,i)})),s.open("GET","https://21.javascript.pages.academy/keksobooking/data"),s.send()}}}(),function(){const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=document.querySelector(".ad-form__error-message");let n,r,i,s,d,a;const c=()=>{const e=document.querySelector(".error");window.view.removeMessage(e),document.removeEventListener("mousedown",l),r.removeEventListener("keydown",l),document.removeEventListener("keydown",l)},l=e=>{"keydown"===e.type?e.target.classList.contains("error__button")?window.util.pressEnter(e,c):window.util.pressEscape(e,c):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,c)},u=()=>{window.view.renderErrorMessage(),r=document.querySelector(".error__button"),document.addEventListener("mousedown",l),r.addEventListener("keydown",l),document.addEventListener("keydown",l)},w=()=>{const e=document.querySelector(".success");window.view.removeMessage(e),document.removeEventListener("mousedown",p),document.removeEventListener("keydown",p)},p=e=>{"keydown"===e.type?window.util.pressEscape(e,w):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,w)},m=()=>{window.state.deactivate(),window.view.renderSuccessMessage(),document.addEventListener("mousedown",p),document.addEventListener("keydown",p)},v=e=>{e.preventDefault(),window.network.uploadFormData(new FormData(t),m,u)},f=()=>{window.state.deactivate(),n.removeEventListener("mousedown",y),n.removeEventListener("keydown",y)},y=e=>{"keydown"===e.type?window.util.pressEnter(e,f):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,f)},g=(e,t)=>{((e,t)=>{if("IMG"===t.tagName)t.src=e.result;else{const o=document.createElement("img");t.innerHTML="",o.src=e.result,o.width=70,o.height=70,t.appendChild(o)}e.removeEventListener("load",(()=>{g(e,t)}))})(e,t)},h=()=>{o.classList.remove("error-message--show"),document.removeEventListener("mousedown",L),document.removeEventListener("keydown",L)},L=e=>{"keydown"===e.type?e.target.classList.contains("error-message__button")?window.util.pressEnter(e,h):window.util.pressEscape(e,h):"mousedown"===e.type&&window.util.pressLeftMouseButton(e,h)},E=(t,n)=>{const r=t.files[0],i=r.name.toLowerCase(),s=e.some((e=>i.endsWith(e)));try{if(!s)throw new Error("Загружать можно только картинки, следующих форматов: gif, jpg, jpeg, png.");{const e=new FileReader;e.addEventListener("load",(()=>{g(e,n)})),e.readAsDataURL(r)}}catch(e){d=e.message,o.querySelector(".error-message__text").textContent=d,o.classList.add("error-message--show"),document.addEventListener("mousedown",L),document.addEventListener("keydown",L)}var d},_=()=>{E(d,i)},S=()=>{E(a,s)};window.form={switchState:()=>{t.classList.toggle("ad-form--disabled")},toggle:(e=t)=>{for(let t of e.children)t.disabled=!t.disabled},setAddress:()=>{document.querySelector("#address").value=window.pin.getCoordinate()},startHandling:()=>{t.addEventListener("submit",v)},stopHandling:()=>{t.addEventListener("submit",v)},clear:()=>{n=t.querySelector(".ad-form__reset"),n.addEventListener("mousedown",y),n.addEventListener("keydown",y)},setPriceRange:(e=1e3)=>{const t=document.querySelector("#price");t.placeholder=e,t.min=e},setAvatar:()=>{d=t.querySelector(".ad-form-header__input"),i=t.querySelector(".ad-form-header__preview img"),d.addEventListener("change",_)},setPhoto:()=>{a=t.querySelector(".ad-form__input"),s=t.querySelector(".ad-form__photo"),a.addEventListener("change",S)},resetPhotos:()=>{i.src="img/muffin-grey.svg",s.textContent="",d.removeEventListener("change",_),a.removeEventListener("change",S)},onErrorMsgClose:L,reset:(e=t)=>{e.reset()}}}(),window.form.toggle(),window.form.toggle(window.filter.getElement()),window.pin.initApp(),window.form.setAddress()})();